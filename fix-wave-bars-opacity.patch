// Add this after getting fillColor and strokeColor (around line 73):
const fillOpacity = params.fillOpacity ?? 1;
const strokeOpacity = params.strokeOpacity ?? 1;

// Replace the bar drawing section (around line 159) with:
    // Apply fill opacity
    ctx.save();
    ctx.globalAlpha = fillOpacity;
    ctx.fillStyle = gradient;
    
    const radius = barWidth / 3;
    ctx.beginPath();
    ctx.roundRect(x, waveY - barHeight/2, barWidth, barHeight, radius);
    ctx.fill();
    
    if (barHeight > 25) {
      ctx.beginPath();
      ctx.arc(x + barWidth/2, waveY - barHeight/2 - 4, barWidth/2.5, 0, Math.PI * 2);
      ctx.arc(x + barWidth/2, waveY + barHeight/2 + 4, barWidth/2.5, 0, Math.PI * 2);
      ctx.fill();
    }
    ctx.restore();

// For the guide line (around line 175), wrap in save/restore:
  ctx.save();
  ctx.globalAlpha = strokeOpacity * 0.15; // Guide line is already semi-transparent
  // ... existing guide line code ...
  ctx.restore();